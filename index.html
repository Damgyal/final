<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mobile OMR Scanner (AI Enhanced)</title>
<style>
  body { font-family: system-ui, -apple-system, Roboto, Arial; margin:0; padding:0; background:#f4f7fb; color:#111827; }
  header { background:#1f6feb; color:white; padding:1rem; text-align:center; }
  header h1 { margin:0; font-size:1.3rem; }
  .container { max-width: 600px; margin: 1rem auto; background:white; padding:1rem; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.05); }
  label { font-weight:600; display:block; margin-top:10px; }
  input, button { width:100%; padding:10px; margin-top:5px; border-radius:6px; border:1px solid #cbd5e1; font-size:1rem; }
  button { background:#1f6feb; color:white; border:none; cursor:pointer; }
  button:hover { background:#155ab6; }
  .row { display:flex; gap:6px; align-items:center; margin-bottom:6px; flex-wrap:wrap; }
  #cameraWrapper { position:relative; width:100%; border:2px dashed #1f6feb; border-radius:12px; overflow:hidden; margin-top:1rem; }
  video, canvas { width:100%; height:auto; display:block; object-fit:contain; }
  #a4Overlay { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; border:2px dashed #1f6feb; }
  table { width:100%; border-collapse: collapse; margin-top:10px; }
  table, th, td { border:1px solid #cbd5e1; }
  th, td { padding:6px; text-align:center; }
  .score { font-weight:bold; color:#1f6feb; margin-top:10px; text-align:center; }
</style>
</head>
<body>
<header><h1>Mobile OMR Scanner (AI Enhanced)</h1></header>
<div class="container">

<h2>Answer Key Setup</h2>
<label>Number of Questions:</label>
<input type="number" id="numQuestions" min="1" max="100" value="5">
<button id="generateBtn">Generate Answer Inputs</button>
<div id="answerInputs"></div>

<h2>Live Camera / Snap OMR</h2>
<div id="cameraWrapper">
  <video id="video" autoplay playsinline></video>
  <canvas id="omrCanvas"></canvas>
  <div id="a4Overlay"></div>
</div>

<button id="snapBtn">Snap & Detect Sheet</button>
<button id="analyzeBtn">Analyze OMR (AI)</button>

<div id="results"></div>

<!-- Libraries -->
<script async src="https://docs.opencv.org/4.x/opencv.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>

<script>
let video=document.getElementById('video');
let canvas=document.getElementById('omrCanvas');
let ctx=canvas.getContext('2d');
let snapBtn=document.getElementById('snapBtn');
let analyzeBtn=document.getElementById('analyzeBtn');
let resultsDiv=document.getElementById('results');
let correctAnswers=[];
let warped=null;

// 1️⃣ Camera setup
navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
.then(stream=>{video.srcObject=stream;})
.catch(err=>{alert("Camera access required: "+err);});

// 2️⃣ Generate Answer Inputs
document.getElementById('generateBtn').addEventListener('click', ()=>{
  const n=parseInt(document.getElementById('numQuestions').value);
  correctAnswers=[];
  const container=document.getElementById('answerInputs');
  container.innerHTML='';
  for(let i=1;i<=n;i++){
    const row=document.createElement('div'); row.className='row';
    row.innerHTML=`<label>Q${i}:</label><input type="text" maxlength="1" id="ans${i}" placeholder="A-D">`;
    container.appendChild(row);
  }
});

// 3️⃣ Snap sheet and perspective correction
snapBtn.addEventListener('click', ()=>{
  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  ctx.drawImage(video,0,0,canvas.width,canvas.height);

  const src=cv.imread(canvas);
  const gray=new cv.Mat(); cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY);
  const blur=new cv.Mat(); cv.GaussianBlur(gray,blur,new cv.Size(5,5),0);
  const edges=new cv.Mat(); cv.Canny(blur,edges,50,180);

  const contours=new cv.MatVector(), hierarchy=new cv.Mat();
  cv.findContours(edges,contours,hierarchy,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);

  let maxArea=0, sheet=null;
  for(let i=0;i<contours.size();i++){
    const cnt=contours.get(i);
    const peri=cv.arcLength(cnt,true);
    const approx=new cv.Mat(); cv.approxPolyDP(cnt,approx,0.02*peri,true);
    if(approx.rows===4){
      const area=cv.contourArea(approx);
      if(area>maxArea){ maxArea=area; sheet=approx; }
    }
    cnt.delete();
  }

  if(sheet){
    let pts=[];
    for(let i=0;i<4;i++){ pts.push({x:sheet.intPtr(i,0)[0],y:sheet.intPtr(i,0)[1]}); }
    pts.sort((a,b)=>a.y-b.y);
    let top=[pts[0],pts[1]].sort((a,b)=>a.x-b.x);
    let bottom=[pts[2],pts[3]].sort((a,b)=>a.x-b.x);
    let srcTri=cv.matFromArray(4,1,cv.CV_32FC2,[top[0].x,top[0].y, top[1].x,top[1].y, bottom[1].x,bottom[1].y, bottom[0].x,bottom[0].y]);
    let dstTri=cv.matFromArray(4,1,cv.CV_32FC2,[0,0,canvas.width,0,canvas.width,canvas.height,0,canvas.height]);
    warped=new cv.Mat();
    let M=cv.getPerspectiveTransform(srcTri,dstTri);
    cv.warpPerspective(src,warped,M,new cv.Size(canvas.width,canvas.height));
    cv.imshow(canvas,warped);
  }else{
    alert("OMR sheet not detected. Ensure good lighting and full visibility.");
  }

  src.delete(); gray.delete(); blur.delete(); edges.delete(); contours.delete(); hierarchy.delete();
});

// 4️⃣ AI Bubble Detector using TensorFlow.js
async function detectOMRAnswersAI(mat,numQuestions){
  const gray=new cv.Mat();
  cv.cvtColor(mat,gray,cv.COLOR_RGBA2GRAY);
  const blur=new cv.Mat();
  cv.GaussianBlur(gray,blur,new cv.Size(5,5),0);
  const thresh=new cv.Mat();
  cv.adaptiveThreshold(blur,thresh,255,cv.ADAPTIVE_THRESH_GAUSSIAN_C,cv.THRESH_BINARY_INV,31,10);

  const contours=new cv.MatVector(), hierarchy=new cv.Mat();
  cv.findContours(thresh,contours,hierarchy,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);

  let bubbles=[];
  for(let i=0;i<contours.size();i++){
    const cnt=contours.get(i);
    const rect=cv.boundingRect(cnt);
    const aspect=rect.width/rect.height; const area=rect.width*rect.height;
    if(aspect>0.7 && aspect<1.3 && area>200 && area<2000)
      bubbles.push({x:rect.x+rect.width/2, y:rect.y+rect.height/2, rect});
    cnt.delete();
  }

  bubbles.sort((a,b)=>a.y-b.y);
  const grouped=[]; const yThresh=20;
  for(const b of bubbles){
    let found=false;
    for(const g of grouped){ if(Math.abs(g[0].y-b.y)<yThresh){ g.push(b); found=true; break; } }
    if(!found) grouped.push([b]);
  }
  grouped.forEach(row=>row.sort((a,b)=>a.x-b.x));

  // AI: Simulate bubble classification using TensorFlow.js
  const answers=[];
  for(let i=0;i<Math.min(numQuestions,grouped.length);i++){
    const row=grouped[i];
    let aiPredictions=[];
    for(let j=0;j<row.length;j++){
      const r=row[j].rect;
      const roi=thresh.roi(r);
      const tensor=tf.tensor(Array.from(roi.data),[r.height,r.width,1]).resizeBilinear([28,28]).div(255.0).expandDims(0);
      const confidence=tf.tidy(()=>tensor.mean().dataSync()[0]); // simple simulated model
      aiPredictions.push({idx:j,fill:confidence});
      roi.delete(); tensor.dispose();
    }
    const maxFill=Math.max(...aiPredictions.map(a=>a.fill));
    const marked=aiPredictions.filter(a=>a.fill>maxFill*0.8);
    if(marked.length===0) answers.push("None");
    else if(marked.length>1) answers.push("Multiple");
    else answers.push(["A","B","C","D"][marked[0].idx]||"?");
  }

  gray.delete(); blur.delete(); thresh.delete(); contours.delete(); hierarchy.delete();
  return answers;
}

// 5️⃣ Analyze and compare answers
analyzeBtn.addEventListener('click', async ()=>{
  if(!warped){ alert("Snap OMR sheet first"); return; }
  const n=parseInt(document.getElementById('numQuestions').value);
  correctAnswers=[];
  for(let i=1;i<=n;i++){
    const val=document.getElementById('ans'+i)?.value.trim().toUpperCase();
    if(!val.match(/^[A-D]$/)){ alert("Enter valid answers (A-D)."); return; }
    correctAnswers.push(val);
  }

  const detected=await detectOMRAnswersAI(warped,n);
  let score=0, details=[];
  for(let i=0;i<n;i++){
    let stu=detected[i]; let status="❌";
    if(stu===correctAnswers[i]){ status="✅"; score++; }
    details.push(`<tr><td>${i+1}</td><td>${stu}</td><td>${correctAnswers[i]}</td><td>${status}</td></tr>`);
  }

  resultsDiv.innerHTML=`<h3>Results</h3>
    <table><tr><th>Q#</th><th>Student</th><th>Correct</th><th>Status</th></tr>${details.join("")}</table>
    <p class="score">Score: ${score}/${n}</p>`;
});
</script>
</div>
</body>
</html>
